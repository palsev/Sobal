var ge=Object.defineProperty;var ve=(e,s,a)=>s in e?ge(e,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[s]=a;var Z=(e,s,a)=>(ve(e,typeof s!="symbol"?s+"":s,a),a);import{c as R,S as j,N as A,R as k,Z as x,u as fe}from"./connector-d867b6ec.js";import{aZ as we,aO as J,aq as G,aY as Y,a$ as X,aP as ee,b6 as te,b2 as _,aV as he,au as be,aW as Te}from"./BalBtn-a3a093af.js";import{l as z}from"./index-c7e2fe85.js";import{s as Se}from"./api-069228f5.js";import{v as W,q as y,ah as Ee,r as F,p as D}from"./runtime-core.esm-bundler-24a2b16f.js";import{L as ke}from"./user-data.provider-5f113b17.js";function N(e){return e.every(s=>s===e[0])}R.network.subgraphs.gauge;function ne(e,s,a,i={},r){const m=W([...j.initial(s),{...j.last(s)}]);return we(m,async()=>{if(!e)throw new Error("A graphQL endpoint wasn't supplied for this query");const b={query:z.jsonToGraphQLQuery({query:a()})};try{if(r){const T=await Se.get(b);return T==null?void 0:T.data.data}const{data:{data:c}}=await J.post(e,{query:z.jsonToGraphQLQuery({query:a()})});return c}catch(c){throw console.error(`GraphQL request to [${e}] failed. Payload:`,a,"Error:",c),c}},i)}const Be={id:!0,bias:!0,slope:!0,timestamp:!0};function Ie(e,s){const{account:a}=G(),i=y(()=>a.value?e===A.MAINNET?!0:!!s.value:!1);return ne(k[e].subgraphs.gauge,Y.Gauges.VotingEscrowLocksByNetworkId(e,a,s),()=>{var r;return{__name:"VotingEscrowLocks",votingEscrowLocks:{__args:{where:{user:(r=s.value)==null?void 0:r.toLowerCase()}},...Be}}},W({enabled:i,refetchOnWindowFocus:!1}))}function K(e,s){const{account:a}=G(),i=y(()=>{var p,l;if(e===A.MAINNET)return a.value;const u=k[e].layerZeroChainId||"";return(l=(p=s.value)==null?void 0:p[u])==null?void 0:l.remoteUser}),{data:r,refetch:m,isError:v,isInitialLoading:b}=Ie(e,i),c=y(()=>{var u;return(u=r.value)==null?void 0:u.votingEscrowLocks[0]});function T(u,p){if(!u||!p||!c.value)return B.Unsynced;const l=u.bias,f=u.slope,S=p.bias,g=p.slope,E=c.value.bias,d=c.value.slope;if(!u.slope||!p.slope||!d)return B.Unsynced;const w=N([l,S,E])&&N([f,g,d]),O=N([l,S])&&N([f,g])&&f!==d&&l!==E;return w?B.Synced:O?B.Syncing:B.Unsynced}function M(){var g,E,d;const u=(g=c.value)==null?void 0:g.bias,p=(E=c.value)==null?void 0:E.slope,l=(d=c.value)==null?void 0:d.timestamp;if(!u||!p||!l)return x(0).toFixed(4).toString();const f=x(p).multipliedBy(Math.floor(Date.now()/1e3)-l);if(f.isLessThan(0))return x(u).toFixed(4).toString();const S=x(u).minus(f);return S.isLessThan(0)?x(0).toFixed(4).toString():S.toFixed(4).toString()}return{getNetworkSyncState:T,votingEscrowLocks:c,refetch:m,calculateVeBAlBalance:M,isLoading:b,isError:v}}const xe={id:!0,localUser:{id:!0},remoteUser:!0,bias:!0,slope:!0,dstChainId:!0};function Le(e){const{networkId:s}=fe(),a=y(()=>!!e.value),i=Y.Gauges.OmniEscrowLocks(s,e);return ne(k[A.MAINNET].subgraphs.gauge,i,()=>{var r;return{__name:"OmniEscrowLocks",omniVotingEscrowLocks:{__args:{where:{localUser:(r=e.value)==null?void 0:r.toLowerCase()}},...xe}}},W({enabled:a,refetchOnWindowFocus:!1}))}const Ce=[{inputs:[{internalType:"contract IVault",name:"vault",type:"address"}],stateMutability:"nonpayable",type:"constructor"},{anonymous:!1,inputs:[{indexed:!1,internalType:"bytes",name:"newAdapterParams",type:"bytes"}],name:"AdapterParamsUpdated",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"contract IOmniVotingEscrow",name:"newOmniVotingEscrow",type:"address"}],name:"OmniVotingEscrowUpdated",type:"event"},{anonymous:!1,inputs:[{indexed:!1,internalType:"bool",name:"newUseZero",type:"bool"}],name:"UseZeroUpdated",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"newZeroPaymentAddress",type:"address"}],name:"ZeroPaymentAddressUpdated",type:"event"},{inputs:[{internalType:"uint16",name:"_dstChainId",type:"uint16"}],name:"estimateSendUserBalance",outputs:[{internalType:"uint256",name:"nativeFee",type:"uint256"},{internalType:"uint256",name:"zroFee",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes4",name:"selector",type:"bytes4"}],name:"getActionId",outputs:[{internalType:"bytes32",name:"",type:"bytes32"}],stateMutability:"view",type:"function"},{inputs:[],name:"getAdapterParams",outputs:[{internalType:"bytes",name:"",type:"bytes"}],stateMutability:"view",type:"function"},{inputs:[],name:"getAuthorizer",outputs:[{internalType:"contract IAuthorizer",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[],name:"getOmniVotingEscrow",outputs:[{internalType:"contract IOmniVotingEscrow",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[],name:"getUseZero",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[],name:"getVault",outputs:[{internalType:"contract IVault",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[],name:"getZeroPaymentAddress",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"_user",type:"address"},{internalType:"uint16",name:"_dstChainId",type:"uint16"},{internalType:"address payable",name:"_refundAddress",type:"address"}],name:"sendUserBalance",outputs:[],stateMutability:"payable",type:"function"},{inputs:[{internalType:"bytes",name:"adapterParams",type:"bytes"}],name:"setAdapterParams",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"contract IOmniVotingEscrow",name:"omniVotingEscrow",type:"address"}],name:"setOmniVotingEscrow",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bool",name:"useZro",type:"bool"}],name:"setUseZero",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"paymentAddress",type:"address"}],name:"setZeroPaymentAddress",outputs:[],stateMutability:"nonpayable",type:"function"}];class Ne{constructor(s,a=ee.jsonProvider,i=Ce,r=te){Z(this,"instance");this.address=s,this.provider=a,this.abi=i,this.walletService=r,this.instance=new X(this.address,this.abi,this.provider)}async estimateSendUserBalance(s,a){return await new _(s).contract.callStatic({contractAddress:this.address,abi:this.abi,action:"estimateSendUserBalance",params:[a]})}async sendUserBalance(s){const{userAddress:a,chainId:i,nativeFee:r,signer:m}=s;return await new _(m).contract.sendTransaction({contractAddress:this.address,abi:this.abi,action:"sendUserBalance",params:[a,i,a],options:{value:r}})}}const Ue=[{inputs:[{internalType:"contract IVeDelegationProxy",name:"veDelegationProxy",type:"address"},{internalType:"bool",name:"readTotalSupplyFromVE",type:"bool"}],stateMutability:"nonpayable",type:"constructor"},{inputs:[],name:"getVotingEscrow",outputs:[{internalType:"contract IERC20",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[],name:"getVotingEscrowDelegationProxy",outputs:[{internalType:"contract IVeDelegation",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"contract IGauge",name:"gauge",type:"address"},{internalType:"address",name:"user",type:"address"}],name:"getWorkingBalanceToSupplyRatios",outputs:[{internalType:"uint256",name:"",type:"uint256"},{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"contract IGauge",name:"gauge",type:"address"},{internalType:"address",name:"user",type:"address"}],name:"getWorkingBalances",outputs:[{internalType:"uint256",name:"",type:"uint256"},{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"readsTotalSupplyFromVE",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"}];class Ae{constructor(s,a=ee.jsonProvider,i=Ue,r=te){Z(this,"instance");this.address=s,this.provider=a,this.abi=i,this.walletService=r,this.instance=new X(this.address,this.abi,this.provider)}async getWorkingBalanceToSupplyRatios(s){const{signer:a,gauge:i,userAddress:r}=s;return await new _(a).contract.callStatic({contractAddress:this.address,abi:this.abi,action:"getWorkingBalanceToSupplyRatios",params:[i,r]})}}var Me={testnet:"https://api-testnet.layerzero-scan.com",mainnet:"https://api-mainnet.layerzero-scan.com",sandbox:"https://api-sandbox.layerzero-scan.com"},Oe=(e,s)=>{const a=Me[e];if(!a)throw new Error(`No endpoint for env ${e}`);const i=J.create({baseURL:a});return{async getMessagesBySrcTxHash(r){if(!r)throw new Error("srcTxHash must be provided");const{data:m}=await i.get(`/tx/${r}`);return m}}};function Ve(e,s){const a=e<1e4?"mainnet":e<2e4?"testnet":"sandbox";return Oe(a).getMessagesBySrcTxHash(s)}var B=(e=>(e.Unsynced="Unsynced",e.Syncing="Syncing",e.Synced="Synced",e.Unknown="Unknown",e))(B||{});const U=Object.keys(k).filter(e=>k[Number(e)].supportsVeBalSync).map(e=>Number(e)),Pe=1e3*30,Ze=1e3*5,Fe=()=>{const{account:e,getSigner:s}=G(),{t:a}=be(),i=localStorage.getItem("tempSyncingNetworks"),r=F(i?JSON.parse(i):{}),m=localStorage.getItem("syncTxHashes"),v=F(m?JSON.parse(m):{}),b=F({}),{data:c,isInitialLoading:T,refetch:M,isError:u}=Le(e),p=y(()=>{var t;return((t=c.value)==null?void 0:t.omniVotingEscrowLocks.length)===0}),l=y(()=>p.value||!c.value?null:c.value.omniVotingEscrowLocks.reduce((t,n)=>(t[n.dstChainId]=n,t),{})),f=K(A.MAINNET,l),S=y(()=>f.votingEscrowLocks.value),g={};U.forEach(t=>{g[t]=K(t,l)});const E=y(()=>T.value||f.isLoading.value),d=y(()=>U.reduce((n,o)=>{var h;return n[o]=g[o].getNetworkSyncState((h=l.value)==null?void 0:h[k[o].layerZeroChainId||""],S.value),n},{})),w=y(()=>{if(!d.value)return{synced:[],unsynced:[],syncing:[]};const t=Object.keys(d.value).map(n=>Number(n));return{synced:t.filter(n=>d.value[n]==="Synced"),unsynced:t.filter(n=>d.value[n]==="Unsynced"),syncing:t.filter(n=>{var o;return d.value[n]==="Syncing"||((o=r.value[e.value])==null?void 0:o.networks.includes(n))})}}),O=y(()=>{const t=[...w.value.unsynced,...w.value.syncing];return[...new Set(t)]}),ae=y(()=>{const t=U.some(n=>g[n].isError.value);return u.value||t}),re=y(()=>U.reduce((n,o)=>(n[o]=g[o].calculateVeBAlBalance(),n),{})),H=y(()=>w.value.syncing.length>0?{title:a("crossChainBoost.syncProcessWarning.title"),text:a("crossChainBoost.syncProcessWarning.description")}:null),oe=y(()=>H.value?null:w.value.synced.length>0?{title:a("crossChainBoost.updateGauge.title"),text:a("crossChainBoost.updateGauge.description")}:null);async function ie(t){const n=R.network.addresses.omniVotingEscrow;if(!n)throw new Error("No contract address found");const o=s(),h=new Ne(n),I=k[t].layerZeroChainId;if(!I)throw new Error("Must specify layer zero chain id");const V=await h.estimateSendUserBalance(o,I),{nativeFee:P}=V;return await h.sendUserBalance({signer:o,userAddress:e.value,chainId:I,nativeFee:P})}async function Q(){if(await Promise.all([M(),f.refetch()]),l.value){const t=w.value.syncing.map(n=>g[n].refetch());await Promise.all(t)}}let L;function q(){L=setInterval(()=>{Q()},Pe)}function ce(t){var n;return(n=r.value)!=null&&n[e.value]?r.value[e.value].networks=[...r.value[e.value].networks,...t]:r.value[e.value]={networks:t,syncTimestamp:Date.now()},r.value[e.value].syncTimestamp=Date.now(),r.value}async function ue(t,n){v.value[e.value]={...v.value[e.value],[t]:n},localStorage.setItem("syncTxHashes",JSON.stringify(v.value))}function le(){r.value[e.value]&&(r.value[e.value].networks=r.value[e.value].networks.filter(t=>!w.value.synced.includes(t)),localStorage.setItem("tempSyncingNetworks",JSON.stringify(r.value)))}async function ye(t){const n=R.network.addresses.gaugeWorkingBalanceHelper;if(!n)throw new Error("No contract address found");const o=s();return new Ae(n).getWorkingBalanceToSupplyRatios({signer:o,userAddress:e.value,gauge:t})}async function de(t){const n=new ke(t),o=s();return n.checkpointUser({signer:o,userAddress:e.value})}async function $(t){const{messages:n}=await Ve(101,t),o=n[0];if(!o)return console.error("No message found in Layer Zero"),"";const{srcUaAddress:h,dstUaAddress:I,dstChainId:V,srcUaNonce:P}=o;return`https://layerzeroscan.com/101/address/${h}/message/${V}/address/${I}/nonce/${P}`}D(()=>w.value,t=>{t.synced.length>0&&t.syncing.some(o=>t.synced.includes(o))&&le(),t.syncing.length>0&&!L&&q(),t.syncing.length===0&&L&&clearInterval(L)});let C;function pe(t){C&&clearInterval(C);let n=0;C=setInterval(async()=>{for(const o of t){const h=v.value[e.value][o];b.value[o]=await $(h)}n++,(t.every(o=>b.value[o])||n>10)&&clearInterval(C)},Ze)}return D(()=>[v.value,e.value],async t=>{const n=t[0];!n||!n[e.value]||pe(Object.keys(n[e.value]))},{immediate:!0,deep:!0}),{showingUnsyncedNetworks:O,hasError:ae,omniEscrowLocksMap:l,networksSyncState:d,isLoading:E,networksBySyncState:w,l2VeBalBalances:re,sync:ie,refetch:Q,tempSyncingNetworks:r,refetchOnInterval:q,setTempSyncingNetworks:ce,warningMessage:H,infoMessage:oe,getGaugeWorkingBalance:ye,triggerGaugeUpdate:de,getLayerZeroTxLink:$,syncTxHashes:v,setSyncTxHashes:ue,syncLayerZeroTxLinks:b}},se=Symbol(Te.Providers.CrossChainSync);function $e(){const e=Fe();return Ee(se,e),e}const je=()=>he(se);export{B as N,$e as p,je as u};
//# sourceMappingURL=cross-chain-sync.provider-ae200010.js.map
